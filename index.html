<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ODT Generator â€“ mehrere Bilder im Dokument</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0078ff" />

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
:root {
  --primary: #0078ff;
  --primary-dark: #005fd4;
  --bg: #f5f7fa;
  --card-bg: #ffffff;
  --radius: 12px;
  --shadow: 0 2px 6px rgba(0,0,0,0.1);
}

body {
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: #222;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

header {
  background: var(--primary);
  color: white;
  width: 100%;
  padding: 1rem;
  text-align: center;
  font-size: 1.25rem;
  font-weight: 600;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 10;
}

main {
  width: 100%;
  max-width: 900px;
  padding: 1rem;
  box-sizing: border-box;
}

fieldset {
  background: var(--card-bg);
  border-radius: var(--radius);
  border: 1px solid #ccc;
  padding: 1rem;
  margin: 1rem 0;
  box-shadow: var(--shadow);
}

legend {
  font-weight: 600;
  color: var(--primary-dark);
}

label {
  display: block;
  margin: 0.5rem 0 0.25rem;
  font-size: 0.95rem;
}

input[type="text"],
input[type="file"] {
  width: 100%;
  box-sizing: border-box;
  padding: 0.6rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
}

button {
  display: block;
  width: 100%;
  padding: 0.8rem;
  background: var(--primary);
  color: white;
  font-size: 1.1rem;
  font-weight: 500;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: background 0.2s ease-in-out;
}

button:hover,
button:active {
  background: var(--primary-dark);
}

#imagePreview {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.preview {
  width: 100%;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: var(--shadow);
}

/* Responsive tweaks */
@media (max-width: 600px) {
  header {
    font-size: 1.1rem;
    padding: 0.75rem;
  }

  fieldset {
    padding: 0.75rem;
  }

  input, button {
    font-size: 1rem;
  }
}
</style>
</head>

<body>
<header>ðŸ“„ ODT Generator</header>
<main>

  <!-- ODT Vorlage -->
  <fieldset>
    <legend>Vorlage laden</legend>
    <input type="file" id="odtInput" accept=".odt" />
  </fieldset>

  <!-- Variablen -->
  <div id="vars"></div>

  <!-- Bilder -->
  <fieldset>
    <legend>Bilder hinzufÃ¼gen (mehrere mÃ¶glich)</legend>
    <input type="file" id="imagesInput" multiple accept="image/*" />
    <div id="imagePreview"></div>
  </fieldset>

  <!-- Export -->
  <button id="exportBtn">ðŸ“¤ Exportieren als ODT</button>

</main>

<script>
let odtZip, contentXml = "", variables = [], images = [];

// ðŸ“‚ Vorlage laden
document.getElementById("odtInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  odtZip = await JSZip.loadAsync(await file.arrayBuffer());
  contentXml = await odtZip.file("content.xml").async("string");

  // Variablen auslesen
  variables = [...new Set([...contentXml.matchAll(/\{\{(.*?)\}\}/g)]
    .map(m => m[1])
    .filter(v => !v.startsWith("#") && !v.startsWith("/") && !v.startsWith("!")))];

  buildVarInputs();
});

// Eingabefelder erstellen
function buildVarInputs() {
  const varsDiv = document.getElementById("vars");
  varsDiv.innerHTML = "";
  if (variables.length === 0) {
    varsDiv.innerHTML = `<fieldset><legend>Text-Variablen</legend><p>Keine Variablen gefunden.</p></fieldset>`;
    return;
  }

  const fs = document.createElement("fieldset");
  fs.innerHTML = "<legend>Text-Variablen</legend>";

  variables.forEach(v => {
    const label = document.createElement("label");
    label.textContent = v + ": ";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "var-" + v;
    fs.appendChild(label);
    fs.appendChild(input);
  });

  varsDiv.appendChild(fs);
}

// ðŸ“¸ Mehrere Bilder auswÃ¤hlen + Vorschau
document.getElementById("imagesInput").addEventListener("change", async e => {
  const files = [...e.target.files];
  const preview = document.getElementById("imagePreview");

  for (const file of files) {
    const base64 = await toBase64(file);
    const dims = await getImageSize(base64);
    const imageData = {
      name: `${Date.now()}_${file.name}`,
      data: await file.arrayBuffer(),
      width: dims.width,
      height: dims.height
    };
    images.push(imageData);

    const img = document.createElement("img");
    img.src = base64;
    img.className = "preview";
    preview.appendChild(img);
  }

  e.target.value = "";
});

function toBase64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

function getImageSize(base64) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => resolve({ width: img.width, height: img.height });
    img.src = base64;
  });
}

// ðŸ’¾ Exportieren
document.getElementById("exportBtn").addEventListener("click", async () => {
  if (!odtZip) return alert("Bitte zuerst eine Vorlage laden!");

  let xml = contentXml;

  // Variablen ersetzen
  variables.forEach(v => {
    const val = document.getElementById("var-" + v)?.value || "";
    xml = xml.replace(new RegExp(`\\{\\{${v}\\}\\}`, "g"), val);
  });

  // Bilder einfÃ¼gen
  let imageSection = "";
  let count = 0;
  for (const img of images) {
    const pxToCm = px => px * 0.0264;
    const maxWcm = 16, maxHcm = 12;
    let w = pxToCm(img.width), h = pxToCm(img.height);
    if (w > maxWcm) { const s = maxWcm / w; w = maxWcm; h *= s; }
    if (h > maxHcm) { const s = maxHcm / h; h = maxHcm; w *= s; }

    const draw = `
      <text:p text:style-name="Standard" text:align="center">
        <draw:frame draw:style-name="fr1" draw:name="${img.name}"
          text:anchor-type="as-char" svg:width="${w.toFixed(2)}cm" svg:height="${h.toFixed(2)}cm">
          <draw:image xlink:href="Pictures/${img.name}" xlink:type="simple"
            xlink:show="embed" xlink:actuate="onLoad"/>
        </draw:frame>
      </text:p>`;

    imageSection += draw + "\n";
    count++;
    if (count % 2 === 0) imageSection += `<text:p text:style-name="Standard"><text:soft-page-break/></text:p>\n`;

    odtZip.file(`Pictures/${img.name}`, img.data);
  }

  xml = xml.replace(/<\/office:text>/, imageSection + "\n</office:text>");
  xml = xml.replace(/\{\{[^}]+\}\}/g, "");
  odtZip.file("content.xml", xml);
  const blob = await odtZip.generateAsync({ type: "blob" });
  saveAs(blob, "export.odt");
});
</script>
</body>
</html>
